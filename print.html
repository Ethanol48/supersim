<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Supersim</title>
        <meta name="robots" content="noindex">


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="introduction.html">Introduction</a></li><li class="chapter-item expanded affix "><li class="part-title">Getting Started</li><li class="chapter-item expanded "><a href="getting-started/installation.html"><strong aria-hidden="true">1.</strong> Installation</a></li><li class="chapter-item expanded "><a href="getting-started/first-steps.html"><strong aria-hidden="true">2.</strong> First steps</a></li><li class="chapter-item expanded affix "><li class="part-title">CLI Reference</li><li class="chapter-item expanded "><a href="reference/supersim.html"><strong aria-hidden="true">3.</strong> supersim</a></li><li class="chapter-item expanded "><a href="reference/supersim-fork.html"><strong aria-hidden="true">4.</strong> supersim fork</a></li><li class="chapter-item expanded affix "><li class="part-title">Chain Environment</li><li class="chapter-item expanded "><a href="chain-environment/contracts/index.html"><strong aria-hidden="true">5.</strong> Included contracts</a></li><li class="chapter-item expanded "><a href="chain-environment/network-details/index.html"><strong aria-hidden="true">6.</strong> Network details & contract addresses</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="chain-environment/network-details/op-chain-a.html"><strong aria-hidden="true">6.1.</strong> OPChainA</a></li><li class="chapter-item expanded "><a href="chain-environment/network-details/op-chain-b.html"><strong aria-hidden="true">6.2.</strong> OPChainB</a></li></ol></li><li class="chapter-item expanded "><li class="part-title">Guides</li><li class="chapter-item expanded "><a href="guides/deposit-transactions.html"><strong aria-hidden="true">7.</strong> Sending deposit transactions</a></li><li class="chapter-item expanded "><a href="guides/interop/index.html"><strong aria-hidden="true">8.</strong> Interoperability</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="guides/interop/manually-relaying-interop-messages-cast.html"><strong aria-hidden="true">8.1.</strong> Manually relaying interop messages with cast</a></li><li class="chapter-item expanded "><a href="guides/interop/relay-using-viem.html"><strong aria-hidden="true">8.2.</strong> Using viem to relay interop messages (TypeScript)</a></li><li class="chapter-item expanded "><a href="guides/interop/writing-contract-using-l2cdm.html"><strong aria-hidden="true">8.3.</strong> Writing cross-chain contract using L2ToL2CrossDomainMessenger</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">8.4.</strong> Calling a contract on destination chain</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">8.5.</strong> Bridging SuperchainWETH</div></li></ol></li><li class="chapter-item expanded "><li class="part-title">Examples</li><li class="chapter-item expanded "><a href="examples/cross-chain-tictactoe.html"><strong aria-hidden="true">9.</strong> Cross-chain tic-tac-toe</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Supersim</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/ethereum-optimism/supersim" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="introduction"><a class="header" href="#introduction">Introduction</a></h1>
<p>Supersim is a lightweight tool to simulate the Superchain (with a single L1 and multiple OP-Stack L2s).</p>
<p>Run multiple local nodes with one command, and coordinate message passing between these chains.</p>
<p>It does not require a complicated devnet setup and is run using cli commands with configuration options that fall back to sensible defaults if they are not specified. Each chain is an instance of <a href="https://book.getfoundry.sh/reference/anvil/">anvil</a>, though future versions may support other local testing tools.</p>
<h2 id="features"><a class="header" href="#features">Features</a></h2>
<ul>
<li>spin up multiple anvil nodes</li>
<li>predeployed OP Stack contracts and useful mock contracts (ERC20)</li>
<li>fork multiple remote chains (fork the entire Superchain)</li>
<li>simulate L1 &lt;&gt; L2 message passing (deposits)</li>
<li>simulate L2 &lt;&gt; L2 message passing (interoperability) and auto-relayer</li>
<li>(<strong>Coming soon</strong>) Withdrawals</li>
<li>(<strong>Coming soon</strong>) ERC-4337 account abstraction services (bundlers / paymasters / wallet implementation)</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="installation"><a class="header" href="#installation">Installation</a></h1>
<h2 id="1-prerequisites-foundry"><a class="header" href="#1-prerequisites-foundry">1. Prerequisites: <code>foundry</code></a></h2>
<p><code>supersim</code> requires <code>anvil</code> to be installed.</p>
<p>Follow the guide <a href="https://book.getfoundry.sh/getting-started/installation">here</a> to install the Foundry toolchain.</p>
<h2 id="2-install-supersim"><a class="header" href="#2-install-supersim">2. Install <code>supersim</code></a></h2>
<h3 id="precompiled-binaries"><a class="header" href="#precompiled-binaries">Precompiled Binaries</a></h3>
<p>Download the executable for your platform from the <a href="https://github.com/ethereum-optimism/supersim/releases">GitHub releases page</a>.</p>
<h3 id="homebrew-os-x-linux"><a class="header" href="#homebrew-os-x-linux">Homebrew (OS X, Linux)</a></h3>
<pre><code class="language-sh">brew tap ethereum-optimism/tap
brew install supersim
</code></pre>
<h2 id="3-start-supersim-in-vanilla-mode"><a class="header" href="#3-start-supersim-in-vanilla-mode">3. Start <code>supersim</code> in vanilla mode</a></h2>
<pre><code class="language-sh">supersim
</code></pre>
<p>Vanilla mode will start 3 chains, with the OP Stack contracts already deployed.</p>
<ul>
<li>(1) L1 Chain
<ul>
<li>Chain 900</li>
</ul>
</li>
<li>(2) L2 Chains
<ul>
<li>Chain 901</li>
<li>Chain 902</li>
</ul>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="first-steps"><a class="header" href="#first-steps">First steps</a></h1>
<p><code>supersim</code> allows testing multichain features <strong>locally</strong>. Previously, testing multichain features required complex docker setups or using a testnet.</p>
<p>To see it in practice, let's first try sending some ETH from the L1 to the L2.</p>
<h2 id="deposit-eth-from-the-l1-into-the-l2-l1-to-l2-message-passing"><a class="header" href="#deposit-eth-from-the-l1-into-the-l2-l1-to-l2-message-passing">Deposit ETH from the L1 into the L2 (L1 to L2 message passing)</a></h2>
<p><strong>1. Check initial balance on the L2 (chain 901)</strong></p>
<p>Grab the balance of the sender account on L2:</p>
<pre><code class="language-sh">cast balance 0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266 --rpc-url http://127.0.0.1:9545
</code></pre>
<p><strong>2. Call <code>bridgeETH</code> function on the <code>L1StandardBridgeProxy</code> contract on the L1 (chain 900)</strong></p>
<p>Initiate a bridge transaction on the L1:</p>
<pre><code class="language-sh">cast send 0xa01ae68902e205B420FD164435F299E07b0C778b "bridgeETH(uint32 _minGasLimit, bytes calldata _extraData)" 50000 0x --value 0.1ether --rpc-url http://127.0.0.1:8545 --private-key 0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80
</code></pre>
<p><strong>3. Check the balance on the L2 (chain 901)</strong></p>
<p>Verify that the ETH balance of the sender has increased on the L2:</p>
<pre><code class="language-sh">cast balance 0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266 --rpc-url http://127.0.0.1:9545
</code></pre>
<h2 id="send-an-interoperable-superchainerc20-token-from-chain-901-to-902-l2-to-l2-message-passing"><a class="header" href="#send-an-interoperable-superchainerc20-token-from-chain-901-to-902-l2-to-l2-message-passing">Send an interoperable SuperchainERC20 token from chain 901 to 902 (L2 to L2 message passing)</a></h2>
<p>In a typical L2 to L2 cross-chain transfer, two transactions are required:</p>
<ol>
<li>Send transaction on the source chain – This initiates the token transfer on Chain 901.</li>
<li>Relay message transaction on the destination chain – This relays the transfer details to Chain 902.</li>
</ol>
<p>To simplify this process, you can use the <code>--interop.autorelay</code> flag. This flag automatically triggers the relay message transaction once the initial send transaction is completed on the source chain, improving the developer experience by removing the need to manually send the relay message.</p>
<h3 id="1-start-supersim-with-the-autorelayer-enabled"><a class="header" href="#1-start-supersim-with-the-autorelayer-enabled">1. Start <code>supersim</code> with the autorelayer enabled</a></h3>
<pre><code class="language-sh">supersim --interop.autorelay 
</code></pre>
<h3 id="2-mint-tokens-to-transfer-on-chain-901"><a class="header" href="#2-mint-tokens-to-transfer-on-chain-901">2. Mint tokens to transfer on chain 901</a></h3>
<p>Run the following command to mint 1000 <code>L2NativeSuperchainERC20</code> tokens to the recipient address:</p>
<pre><code class="language-sh">cast send 0x420beeF000000000000000000000000000000001 "mint(address _to, uint256 _amount)"  0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266 1000  --rpc-url http://127.0.0.1:9545 --private-key 0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80

</code></pre>
<h3 id="3-initiate-the-send-transaction-on-chain-901"><a class="header" href="#3-initiate-the-send-transaction-on-chain-901">3. Initiate the send transaction on chain 901</a></h3>
<p>Send the tokens from Chain 901 to Chain 902 using the following command:</p>
<pre><code class="language-sh">cast send 0x420beeF000000000000000000000000000000001 "sendERC20(address _to, uint256 _amount, uint256 _chainId)" 0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266 1000 902 --rpc-url http://127.0.0.1:9545 --private-key 0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80
</code></pre>
<h3 id="4-wait-for-the-relayed-message-to-appear-on-chain-902"><a class="header" href="#4-wait-for-the-relayed-message-to-appear-on-chain-902">4. Wait for the relayed message to appear on chain 902</a></h3>
<p>In a few seconds, you should see the RelayedMessage on chain 902:</p>
<pre><code class="language-sh"># example
INFO [08-30|14:30:14.698] L2ToL2CrossChainMessenger#RelayedMessage sourceChainID=901 destinationChainID=902 nonce=0 sender=0x420beeF000000000000000000000000000000001 target=0x420beeF000000000000000000000000000000001
</code></pre>
<h3 id="5-check-the-balance-on-chain-902"><a class="header" href="#5-check-the-balance-on-chain-902">5. Check the balance on chain 902</a></h3>
<p>Verify that the balance of the L2NativeSuperchainERC20 on chain 902 has increased:</p>
<pre><code class="language-sh">cast balance --erc20 0x420beeF000000000000000000000000000000001 0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266 --rpc-url http://127.0.0.1:9546
</code></pre>
<p>With the steps above, you've now successfully completed both an L1 to L2 ETH bridge and an L2 to L2 interoperable SuperchainERC20 token transfer, all done locally using <code>supersim</code>. This approach simplifies multichain testing, allowing you to focus on development without the need for complex setups or relying on external testnets.</p>
<div style="break-before: page; page-break-before: always;"></div><!-- omit in toc -->
<h1 id="supersim-vanilla-mode"><a class="header" href="#supersim-vanilla-mode">supersim (vanilla mode)</a></h1>
<ul>
<li><a href="reference/supersim.html#overview">Overview</a></li>
<li><a href="reference/supersim.html#configuration">Configuration</a></li>
</ul>
<h2 id="overview"><a class="header" href="#overview">Overview</a></h2>
<p>Start supersim in vanilla (non-forked) mode</p>
<pre><code class="language-sh">supersim
</code></pre>
<p>Vanilla mode will start 3 chains, with the OP Stack contracts &amp; periphery contracts already deployed.</p>
<ul>
<li>(1) L1 Chain
<ul>
<li>Chain 900</li>
</ul>
</li>
<li>(2) L2 Chains
<ul>
<li>Chain 901</li>
<li>Chain 902</li>
</ul>
</li>
</ul>
<p><strong>Example startup logs</strong></p>
<pre><code>Available Accounts
-----------------------
(0): 0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266
(1): 0x70997970C51812dc3A010C7d01b50e0d17dc79C8
(2): 0x3C44CdDdB6a900fa2b585dd299e03d12FA4293BC
(3): 0x90F79bf6EB2c4f870365E785982E1f101E93b906
(4): 0x15d34AAf54267DB7D7c367839AAf71A00a2C6A65
(5): 0x9965507D1a55bcC2695C58ba16FB37d819B0A4dc
(6): 0x976EA74026E726554dB657fA54763abd0C3a0aa9
(7): 0x14dC79964da2C08b23698B3D3cc7Ca32193d9955
(8): 0x23618e81E3f5cdF7f54C3d65f7FBc0aBf5B21E8f
(9): 0xa0Ee7A142d267C1f36714E4a8F75612F20a79720

Private Keys
-----------------------
(0): 0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80
(1): 0x59c6995e998f97a5a0044966f0945389dc9e86dae88c7a8412f4603b6b78690d
(2): 0x5de4111afa1a4b94908f83103eb1f1706367c2e68ca870fc3fb9a804cdab365a
(3): 0x7c852118294e51e653712a81e05800f419141751be58f605c371e15141b007a6
(4): 0x47e179ec197488593b187f80a00eb0da91f1b9d0b13f8733639f19c30a34926a
(5): 0x8b3a350cf5c34c9194ca85829a2df0ec3153be0318b5e2d3348e872092edffba
(6): 0x92db14e403b83dfe3df233f83dfa3a0d7096f21ca9b0d6d6b8d88b2b4ec1564e
(7): 0x4bbbf85ce3377467afe5d46f804f221813b2bb87f24d81f60f1fcdbf7cbf4356
(8): 0xdbda1821b80551c9d65939329250298aa3472ba22feea921c0cf5d620ea67b97
(9): 0x2a871d0798f97d79848a013d4936a73bf4cc922c825d33c1cf7073dff6d409c6

Orchestrator Config:
L1:
  Name: L1    Chain ID: 900    RPC: http://127.0.0.1:8545    LogPath: /var/folders/0w/ethers-phoenix/T/anvil-chain-900
L2:
  Name: OPChainA    Chain ID: 901    RPC: http://127.0.0.1:9545    LogPath: /var/folders/0w/ethers-phoenix/T/anvil-chain-901
  Name: OPChainB    Chain ID: 902    RPC: http://127.0.0.1:9546    LogPath: /var/folders/0w/ethers-phoenix/T/anvil-chain-902
</code></pre>
<h2 id="configuration"><a class="header" href="#configuration">Configuration</a></h2>
<pre><code>NAME:
   supersim - Superchain Multi-L2 Simulator

USAGE:
   supersim [global options] command [command options]

VERSION:
   untagged

DESCRIPTION:
   Local multichain optimism development environment

COMMANDS:
   fork     Locally fork a network in the superchain registry
   help, h  Shows a list of commands or help for one command

GLOBAL OPTIONS:

    --interop.autorelay                 (default: false)                   ($SUPERSIM_INTEROP_AUTORELAY)
          Automatically relay messages sent to the L2ToL2CrossDomainMessenger using
          account 0xa0Ee7A142d267C1f36714E4a8F75612F20a79720

    --l1.port value                     (default: 8545)                    ($SUPERSIM_L1_PORT)
          Listening port for the L1 instance. `0` binds to any available port

    --l2.starting.port value            (default: 9545)                    ($SUPERSIM_L2_STARTING_PORT)
          Starting port to increment from for L2 chains. `0` binds each chain to any
          available port

    --log.color                         (default: false)                   ($SUPERSIM_LOG_COLOR)
          Color the log output if in terminal mode

    --log.format value                  (default: text)                    ($SUPERSIM_LOG_FORMAT)
          Format the log output. Supported formats: 'text', 'terminal', 'logfmt', 'json',
          'json-pretty',

    --log.level value                   (default: INFO)                    ($SUPERSIM_LOG_LEVEL)
          The lowest log level that will be output

    --log.pid                           (default: false)                   ($SUPERSIM_LOG_PID)
          Show pid in the log

    --logs.directory value                                                 ($SUPERSIM_LOGS_DIRECTORY)
          Directory to store logs

   MISC


    --help, -h                          (default: false)
          show help

    --version, -v                       (default: false)
          print the version
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><!-- omit in toc -->
<h1 id="supersim-fork-forked-mode"><a class="header" href="#supersim-fork-forked-mode">supersim fork (forked mode)</a></h1>
<ul>
<li><a href="reference/supersim-fork.html#overview">Overview</a></li>
<li><a href="reference/supersim-fork.html#configuration">Configuration</a></li>
<li><a href="reference/supersim-fork.html#notes">Notes</a>
<ul>
<li><a href="reference/supersim-fork.html#fork-height">Fork height</a></li>
<li><a href="reference/supersim-fork.html#interoperability-contracts">Interoperability contracts</a></li>
</ul>
</li>
</ul>
<h2 id="overview-1"><a class="header" href="#overview-1">Overview</a></h2>
<pre><code class="language-sh">supersim fork
</code></pre>
<p>The supersim fork command simplifies the process of forking multiple chains in the Superchain ecosystem simultaneously. It determines the appropriate block heights for each chain and launches both the L1 and L2 chains based on these values.</p>
<p>If you're relying on contracts already deployed on testnet / mainnet chains, you can use fork mode to simulate and interact with the state of the chain without needing to re-deploy or modify the contracts.</p>
<p>Locally fork any of the available chains in a superchain network of the <a href="https://github.com/ethereum-optimism/superchain-registry">superchain registry</a>, default <code>mainnet</code> versions.</p>
<p><strong>Example startup logs</strong></p>
<pre><code>Available Accounts
-----------------------
(0): 0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266
--- truncated for brevity ---

Private Keys
-----------------------
(0): 0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80
--- truncated for brevity ---

Orchestrator Config:
L1:
  Name: mainnet    Chain ID: 1    RPC: http://127.0.0.1:8545    LogPath: /var/folders/0w/ethers-phoenix/T/anvil-chain-1-1521250718
L2:
  Name: op    Chain ID: 10    RPC: http://127.0.0.1:9545    LogPath: /var/folders/0w/ethers-phoenix/T/anvil-chain-10
  Name: base    Chain ID: 8453    RPC: http://127.0.0.1:9546    LogPath: /var/folders/0w/ethers-phoenix/T/anvil-chain-8453
  Name: zora    Chain ID: 7777777    RPC: http://127.0.0.1:9547    LogPath: /var/folders/0w/ethers-phoenix/T/anvil-chain-7777777
</code></pre>
<h2 id="configuration-1"><a class="header" href="#configuration-1">Configuration</a></h2>
<pre><code>NAME:
   supersim fork - Locally fork a network in the superchain registry

USAGE:
   supersim fork [command options]

OPTIONS:

          --l1.fork.height value              (default: 0)                       ($SUPERSIM_L1_FORK_HEIGHT)
                L1 height to fork the superchain (bounds L2 time). `0` for latest

          --chains value                                                         ($SUPERSIM_CHAINS)
                chains to fork in the superchain, mainnet options: [base, lyra, metal, mode, op,
                orderly, race, tbn, zora]. In order to replace the public rpc endpoint for a
                chain, specify the ($SUPERSIM_RPC_URL_&lt;CHAIN&gt;) env variable. i.e
                SUPERSIM_RPC_URL_OP=http://optimism-mainnet.infura.io/v3/&lt;API-KEY&gt;

          --network value                     (default: "mainnet")               ($SUPERSIM_NETWORK)
                superchain network. options: mainnet, sepolia, sepolia-dev-0. In order to
                replace the public rpc endpoint for the network, specify the
                ($SUPERSIM_RPC_URL_&lt;NETWORK&gt;) env variable. i.e
                SUPERSIM_RPC_URL_MAINNET=http://mainnet.infura.io/v3/&lt;API-KEY&gt;

          --interop.enabled                   (default: true)                    ($SUPERSIM_INTEROP_ENABLED)
                enable interop predeploy and functionality

          --l1.port value                     (default: 8545)                    ($SUPERSIM_L1_PORT)
                Listening port for the L1 instance. `0` binds to any available port

          --l2.starting.port value            (default: 9545)                    ($SUPERSIM_L2_STARTING_PORT)
                Starting port to increment from for L2 chains. `0` binds each chain to any
                available port

          --interop.autorelay                 (default: false)                   ($SUPERSIM_INTEROP_AUTORELAY)
                Automatically relay messages sent to the L2ToL2CrossDomainMessenger using
                account 0xa0Ee7A142d267C1f36714E4a8F75612F20a79720

          --logs.directory value                                                 ($SUPERSIM_LOGS_DIRECTORY)
                Directory to store logs

          --log.level value                   (default: INFO)                    ($SUPERSIM_LOG_LEVEL)
                The lowest log level that will be output

          --log.format value                  (default: text)                    ($SUPERSIM_LOG_FORMAT)
                Format the log output. Supported formats: 'text', 'terminal', 'logfmt', 'json',
                'json-pretty',

          --log.color                         (default: false)                   ($SUPERSIM_LOG_COLOR)
                Color the log output if in terminal mode

          --log.pid                           (default: false)                   ($SUPERSIM_LOG_PID)
                Show pid in the log

          --help, -h                          (default: false)
                show help
</code></pre>
<h2 id="notes"><a class="header" href="#notes">Notes</a></h2>
<h3 id="fork-height"><a class="header" href="#fork-height">Fork height</a></h3>
<p>The fork height is determined by L1 block height (default <code>latest</code>). This is then used to derive the corresponding L2 block to start from.</p>
<h3 id="interoperability-contracts"><a class="header" href="#interoperability-contracts">Interoperability contracts</a></h3>
<p>By default, interop contracts are not deployed on forked networks. To include them, run supersim with the <code>--interop.enabled</code> flag.</p>
<pre><code class="language-sh">supersim fork --chains=op,base,zora --interop.enabled
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><!-- omit in toc -->
<h1 id="included-contracts"><a class="header" href="#included-contracts">Included contracts</a></h1>
<p>The chain environment includes contracts already deployed to help replicate the Superchain environment. You can see an example of contract addresses for a L2 system <a href="chain-environment/contracts//docs/src/chain-environment/network-details/op-chain-a.html">here</a>.</p>
<ul>
<li><a href="chain-environment/contracts/index.html#op-stack-system-contracts-l1">OP Stack system contracts (L1)</a></li>
<li><a href="chain-environment/contracts/index.html#op-stack-l2-contracts-l2">OP Stack L2 contracts (L2)</a></li>
<li><a href="chain-environment/contracts/index.html#periphery-contracts-l2">Periphery contracts (L2)</a>
<ul>
<li><a href="chain-environment/contracts/index.html#l2nativesuperchainerc20">L2NativeSuperchainERC20</a>
<ul>
<li><a href="chain-environment/contracts/index.html#minting-new-tokens">Minting new tokens</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="op-stack-system-contracts-l1"><a class="header" href="#op-stack-system-contracts-l1">OP Stack system contracts (L1)</a></h2>
<p>These are the L1 contracts that are required for a rollup as part of the OP Stack protocol. Examples are the <a href="https://github.com/ethereum-optimism/optimism/blob/develop/packages/contracts-bedrock/src/L1/OptimismPortal.sol">OptimismPortal</a>, <a href="https://github.com/ethereum-optimism/optimism/blob/develop/packages/contracts-bedrock/src/L1/L1StandardBridge.sol">L1StandardBridge</a>, and <a href="https://github.com/ethereum-optimism/optimism/blob/develop/packages/contracts-bedrock/src/L1/L1CrossDomainMessenger.sol">L1CrossDomainMessenger</a>.</p>
<p>View examples of these contracts here the official <a href="https://docs.optimism.io/chain/addresses#ethereum-l1">OP docs</a> or the source code <a href="https://github.com/ethereum-optimism/optimism/tree/develop/packages/contracts-bedrock/src/L1">here in the Optimism monorepo</a></p>
<h2 id="op-stack-l2-contracts-l2"><a class="header" href="#op-stack-l2-contracts-l2">OP Stack L2 contracts (L2)</a></h2>
<p>The OP Stack system contracts on the L2 are included at the standard addresses by default.</p>
<ul>
<li><a href="https://specs.optimism.io/protocol/predeploys.html">Standard OP Stack predeploys (L2)</a></li>
<li><a href="https://specs.optimism.io/interop/predeploys.html">Interoperability predeploys (<em>experimental</em>) (L2)</a></li>
<li><a href="https://specs.optimism.io/protocol/preinstalls.html">OP Stack preinstalls (L2)</a></li>
</ul>
<h2 id="periphery-contracts-l2"><a class="header" href="#periphery-contracts-l2">Periphery contracts (L2)</a></h2>
<p>L2 chains running on <code>supersim</code> also includes some useful contracts for testing purposes that are not part of the OP Stack by default.</p>
<h3 id="l2nativesuperchainerc20"><a class="header" href="#l2nativesuperchainerc20">L2NativeSuperchainERC20</a></h3>
<p>A simple ERC20 that adheres to the SuperchainERC20 standard. It includes permissionless minting for easy testing.</p>
<p>Source: <a href="chain-environment/contracts//contracts/src/L2NativeSuperchainERC20.sol">L2NativeSuperchainERC20.sol</a></p>
<p>Deployed address: <code>0x420beeF000000000000000000000000000000001</code></p>
<h4 id="minting-new-tokens"><a class="header" href="#minting-new-tokens">Minting new tokens</a></h4>
<pre><code class="language-bash">cast send 0x420beeF000000000000000000000000000000001 "mint(address _to, uint256 _amount)" $RECIPIENT_ADDRESS 1ether  --rpc-url $L2_RPC_URL
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="network-details"><a class="header" href="#network-details">Network details</a></h1>
<p>By default, two OP Stack systems will be spun up in vanilla mode</p>
<ul>
<li>OPChainA (chainID 901)</li>
<li>OPChainB (chainID 902)</li>
</ul>
<p>Both "roll up" into a single L1 chain (chainID 900).</p>
<div style="break-before: page; page-break-before: always;"></div><!-- omit in toc -->
<h1 id="opchaina"><a class="header" href="#opchaina">OPChainA</a></h1>
<ul>
<li><a href="chain-environment/network-details/op-chain-a.html#network-details">Network details</a></li>
<li><a href="chain-environment/network-details/op-chain-a.html#contract-addresses">Contract addresses</a>
<ul>
<li><a href="chain-environment/network-details/op-chain-a.html#l1-contracts">L1 contracts</a></li>
<li><a href="chain-environment/network-details/op-chain-a.html#l2-contracts">L2 contracts</a></li>
</ul>
</li>
</ul>
<h2 id="network-details-1"><a class="header" href="#network-details-1">Network details</a></h2>
<div class="table-wrapper"><table><thead><tr><th><strong>Parameter</strong></th><th><strong>Value</strong></th></tr></thead><tbody>
<tr><td><strong>Name</strong></td><td>OPChainA</td></tr>
<tr><td><strong>Chain ID</strong></td><td>901</td></tr>
<tr><td><strong>RPC URL</strong></td><td><a href="http://127.0.0.1:9545">http://127.0.0.1:9545</a></td></tr>
</tbody></table>
</div>
<h2 id="contract-addresses"><a class="header" href="#contract-addresses">Contract addresses</a></h2>
<h3 id="l1-contracts"><a class="header" href="#l1-contracts">L1 contracts</a></h3>
<pre><code class="language-json">{
  "AddressManager": "0x78d21C9820A9135215202A9a8D6521483D4b75cD",
  "AnchorStateRegistry": "0x21799f09394c50220CCD95E7dAc1cdD774FC871a",
  "AnchorStateRegistryProxy": "0xa6F40d5770b3509aB40B2effa5cb544D29743ec7",
  "DelayedWETH": "0x49BBFf1629824A1e7993Ab5c17AFa45D24AB28c9",
  "DelayedWETHProxy": "0x309DA6B9a8fE16afD7D067528d358E55314bEa6b",
  "DisputeGameFactory": "0x20B168142354Cee65a32f6D8cf3033E592299765",
  "DisputeGameFactoryProxy": "0x444689B81D485bc58AB81aC02A95a937fAa152D7",
  "L1CrossDomainMessenger": "0x094e6508ba9d9bf1ce421fff3dE06aE56e67901b",
  "L1CrossDomainMessengerProxy": "0xe5bda89cd85cE0DfB80E053281cA070D65B738e6",
  "L1ERC721Bridge": "0x5C4F5e749A61a9503c4AAE8a9393e89609a0e804",
  "L1ERC721BridgeProxy": "0x018dC24a6617c47cAa00C3fA25097214B2D4F447",
  "L1StandardBridge": "0xb7900B27Be8f0E0fF65d1C3A4671e1220437dd2b",
  "L1StandardBridgeProxy": "0xa01ae68902e205B420FD164435F299E07b0C778b",
  "L2OutputOracle": "0x19652082F846171168Daf378C4fD3ee85a0D4A60",
  "L2OutputOracleProxy": "0x6cE0530E823e23be85D8e151FB023605eB4F6d43",
  "Mips": "0xB3A0348310a0ff78E5FbDB7f14BB7d3e02d40773",
  "OptimismMintableERC20Factory": "0x39Aea2Dd53f2d01c15877aCc2791af6BDD7aD567",
  "OptimismMintableERC20FactoryProxy": "0x15c855966C196Be3a8ca747E8A8Bf40928d4741f",
  "OptimismPortal": "0xb7461Fb347f68f9717e6fD12C8407dEcee063bdc",
  "OptimismPortal2": "0xfcbb237388CaF5b08175C9927a37aB6450acd535",
  "OptimismPortalProxy": "0xF5fe61a258CeBb54CCe428F76cdeD04Cbc12F53d",
  "PreimageOracle": "0x3bd7E801E51d48c5d94Ea68e8B801DFFC275De75",
  "ProtocolVersions": "0xfbfD64a6C0257F613feFCe050Aa30ecC3E3d7C3F",
  "ProtocolVersionsProxy": "0x6dA4f6489039d9f4F3144954DDF5bb2F4986e90b",
  "ProxyAdmin": "0xe32a4D31ffD5596542DAc8239a1DE3Fff9d63475",
  "SafeProxyFactory": "0x4a05c09875DE2DD5B81Bc01dd46eD4699b181bfA",
  "SafeSingleton": "0x99A395CE6d6b37CaaCBad64fB42d556b6CA73a48",
  "SuperchainConfig": "0x068E44eB31e111028c41598E4535be7468674D0A",
  "SuperchainConfigProxy": "0x7E6c6ebCF109fa23277b86bdA39738035C21BB86",
  "SystemConfig": "0x6167B477F8d9138aa509f54b2800443857e28c0f",
  "SystemConfigProxy": "0xf32919Ed2490b56EaD65E72749894aE4C9523320",
  "SystemOwnerSafe": "0xc052b7316C87390E555aF97D42bCd5FB6d5eEFDa"
}
</code></pre>
<h3 id="l2-contracts"><a class="header" href="#l2-contracts">L2 contracts</a></h3>
<pre><code class="language-json">{
  // OP Stack predeploys
  "L2ToL1MessagePasser": "0x4200000000000000000000000000000000000016",
  "L2CrossDomainMessenger": "0x4200000000000000000000000000000000000007",
  "L2StandardBridge": "0x4200000000000000000000000000000000000010",
  "L2ERC721Bridge": "0x4200000000000000000000000000000000000014",
  "SequencerFeeVault": "0x4200000000000000000000000000000000000011",
  "OptimismMintableERC20Factory": "0x4200000000000000000000000000000000000012",
  "OptimismMintableERC721Factory": "0x4200000000000000000000000000000000000017",
  "L1BlockInterop": "0x4200000000000000000000000000000000000015",
  "GasPriceOracle": "0x420000000000000000000000000000000000000F",
  "ProxyAdmin": "0x4200000000000000000000000000000000000018",
  "BaseFeeVault": "0x4200000000000000000000000000000000000019",
  "L1FeeVault": "0x420000000000000000000000000000000000001A",
  "GovernanceToken": "0x4200000000000000000000000000000000000042",
  "SchemaRegistry": "0x4200000000000000000000000000000000000020",
  "EAS": "0x4200000000000000000000000000000000000021",
  "CrossL2Inbox": "0x4200000000000000000000000000000000000022",
  "L2ToL2CrossDomainMessenger": "0x4200000000000000000000000000000000000023",

  // Periphery
  "L2NativeSuperchainERC20": "0x420beeF000000000000000000000000000000001"
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><!-- omit in toc -->
<h1 id="opchainb"><a class="header" href="#opchainb">OPChainB</a></h1>
<ul>
<li><a href="chain-environment/network-details/op-chain-b.html#network-details">Network details</a></li>
<li><a href="chain-environment/network-details/op-chain-b.html#contract-addresses">Contract addresses</a>
<ul>
<li><a href="chain-environment/network-details/op-chain-b.html#l1-contracts">L1 contracts</a></li>
<li><a href="chain-environment/network-details/op-chain-b.html#l2-contracts">L2 contracts</a></li>
</ul>
</li>
</ul>
<h2 id="network-details-2"><a class="header" href="#network-details-2">Network details</a></h2>
<div class="table-wrapper"><table><thead><tr><th><strong>Parameter</strong></th><th><strong>Value</strong></th></tr></thead><tbody>
<tr><td><strong>Name</strong></td><td>OPChainB</td></tr>
<tr><td><strong>Chain ID</strong></td><td>902</td></tr>
<tr><td><strong>RPC URL</strong></td><td><a href="http://127.0.0.1:9546">http://127.0.0.1:9546</a></td></tr>
</tbody></table>
</div>
<h2 id="contract-addresses-1"><a class="header" href="#contract-addresses-1">Contract addresses</a></h2>
<h3 id="l1-contracts-1"><a class="header" href="#l1-contracts-1">L1 contracts</a></h3>
<pre><code class="language-json">{
  "AddressManager": "0xafB51A0f73C8409AeA1207DF7f39885c927BeA46",
  "AnchorStateRegistry": "0x05493149c84A71063f7948127bb931f8377F779C",
  "AnchorStateRegistryProxy": "0xfd0269a716A59fF125Bd7eb65Cd3427C8555bab7",
  "DelayedWETH": "0x49BBFf1629824A1e7993Ab5c17AFa45D24AB28c9",
  "DelayedWETHProxy": "0xA63353128502269b4A4A4c2677fE316cd9ad4397",
  "DisputeGameFactory": "0x20B168142354Cee65a32f6D8cf3033E592299765",
  "DisputeGameFactoryProxy": "0x5F416fEb15c8B382d338FDBDb7D44967ca2b59BC",
  "L1CrossDomainMessenger": "0x094e6508ba9d9bf1ce421fff3dE06aE56e67901b",
  "L1CrossDomainMessengerProxy": "0xCB9768921831677Ae15cE4B64A10B94F49cD88E2",
  "L1ERC721Bridge": "0x5C4F5e749A61a9503c4AAE8a9393e89609a0e804",
  "L1ERC721BridgeProxy": "0xDCE41E6C0901586EE27Eac329EBD4b5fe5A7170d",
  "L1StandardBridge": "0xb7900B27Be8f0E0fF65d1C3A4671e1220437dd2b",
  "L1StandardBridgeProxy": "0x2D8543c236a4d626f54B51Fa8bc229a257C5143E",
  "L2OutputOracle": "0x19652082F846171168Daf378C4fD3ee85a0D4A60",
  "L2OutputOracleProxy": "0x006Af3fB62c4BE4fB0393995d364BbFe6b0F3CB2",
  "Mips": "0xB3A0348310a0ff78E5FbDB7f14BB7d3e02d40773",
  "OptimismMintableERC20Factory": "0x39Aea2Dd53f2d01c15877aCc2791af6BDD7aD567",
  "OptimismMintableERC20FactoryProxy": "0x1A2A942d891e525D1Ab192578a378980729fD585",
  "OptimismPortal": "0xb7461Fb347f68f9717e6fD12C8407dEcee063bdc",
  "OptimismPortal2": "0xfcbb237388CaF5b08175C9927a37aB6450acd535",
  "OptimismPortalProxy": "0xdfC9DEAbEEbDaa7620C71e2E76AEda32919DE5f2",
  "PreimageOracle": "0x3bd7E801E51d48c5d94Ea68e8B801DFFC275De75",
  "ProtocolVersions": "0xfbfD64a6C0257F613feFCe050Aa30ecC3E3d7C3F",
  "ProtocolVersionsProxy": "0xE139cB0CDa5EF722870068ea331d0989776A7aDf",
  "ProxyAdmin": "0xff5E6C2Af859f70B875BA59B958BEde60E36bf69",
  "SafeProxyFactory": "0xb68f3B057fE3c6CdDF9DB35837Ea769FCc81978a",
  "SafeSingleton": "0xeeB44D84d505AbD958d032e90704c56443eB3ED0",
  "SuperchainConfig": "0x068E44eB31e111028c41598E4535be7468674D0A",
  "SuperchainConfigProxy": "0x2ED4AA34573c36bF3856e597501aEf9d9Dc1687C",
  "SystemConfig": "0x6167B477F8d9138aa509f54b2800443857e28c0f",
  "SystemConfigProxy": "0x2Db03FE998D7c20E4B65afD1f50f04Ec4BfAb694",
  "SystemOwnerSafe": "0xBF3830711B7c559042453B7546dB4736eFB4245e"
}
</code></pre>
<h3 id="l2-contracts-1"><a class="header" href="#l2-contracts-1">L2 contracts</a></h3>
<pre><code class="language-json">{
  // OP Stack predeploys
  "L2ToL1MessagePasser": "0x4200000000000000000000000000000000000016",
  "L2CrossDomainMessenger": "0x4200000000000000000000000000000000000007",
  "L2StandardBridge": "0x4200000000000000000000000000000000000010",
  "L2ERC721Bridge": "0x4200000000000000000000000000000000000014",
  "SequencerFeeVault": "0x4200000000000000000000000000000000000011",
  "OptimismMintableERC20Factory": "0x4200000000000000000000000000000000000012",
  "OptimismMintableERC721Factory": "0x4200000000000000000000000000000000000017",
  "L1BlockInterop": "0x4200000000000000000000000000000000000015",
  "GasPriceOracle": "0x420000000000000000000000000000000000000F",
  "ProxyAdmin": "0x4200000000000000000000000000000000000018",
  "BaseFeeVault": "0x4200000000000000000000000000000000000019",
  "L1FeeVault": "0x420000000000000000000000000000000000001A",
  "GovernanceToken": "0x4200000000000000000000000000000000000042",
  "SchemaRegistry": "0x4200000000000000000000000000000000000020",
  "EAS": "0x4200000000000000000000000000000000000021",
  "CrossL2Inbox": "0x4200000000000000000000000000000000000022",
  "L2ToL2CrossDomainMessenger": "0x4200000000000000000000000000000000000023",

  // Periphery
  "L2NativeSuperchainERC20": "0x420beeF000000000000000000000000000000001"
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="deposit-transactions"><a class="header" href="#deposit-transactions">Deposit transactions</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="interoperability"><a class="header" href="#interoperability">Interoperability</a></h1>
<div style="break-before: page; page-break-before: always;"></div><!-- omit in toc -->
<h1 id="manually-relaying-interop-messages-with-cast-and-l2tol2crossdomainmessenger"><a class="header" href="#manually-relaying-interop-messages-with-cast-and-l2tol2crossdomainmessenger">Manually relaying interop messages with <code>cast</code> and L2ToL2CrossDomainMessenger</a></h1>
<p>This guide describes how to form a <a href="https://specs.optimism.io/interop/messaging.html#message-identifier">message identifier</a> to execute a message on a destination chain.</p>
<p>We'll perform the SuperchainERC20 interop transfer in <a href="guides/interop/../../getting-started/first-steps.html#send-an-interoperable-superchainerc20-token-from-chain-901-to-902-l2-to-l2-message-passing">First steps</a> again, this time manually relaying the message without the autorelayer.</p>
<ul>
<li><a href="guides/interop/manually-relaying-interop-messages-cast.html#overview">Overview</a>
<ul>
<li><a href="guides/interop/manually-relaying-interop-messages-cast.html#contracts-used">Contracts used</a></li>
<li><a href="guides/interop/manually-relaying-interop-messages-cast.html#high-level-steps">High level steps</a></li>
<li><a href="guides/interop/manually-relaying-interop-messages-cast.html#message-identifier">Message identifier</a></li>
</ul>
</li>
<li><a href="guides/interop/manually-relaying-interop-messages-cast.html#steps">Steps</a>
<ul>
<li><a href="guides/interop/manually-relaying-interop-messages-cast.html#1-start-supersim">1. Start <code>supersim</code></a></li>
<li><a href="guides/interop/manually-relaying-interop-messages-cast.html#2-mint-tokens-to-transfer-on-chain-901">2. Mint tokens to transfer on chain 901</a></li>
<li><a href="guides/interop/manually-relaying-interop-messages-cast.html#3-initiate-the-send-transaction-on-chain-901">3. Initiate the send transaction on chain 901</a></li>
<li><a href="guides/interop/manually-relaying-interop-messages-cast.html#4-get-the-log-emitted-by-the-l2tol2crossdomainmessenger">4. Get the log emitted by the <code>L2ToL2CrossDomainMessenger</code></a></li>
<li><a href="guides/interop/manually-relaying-interop-messages-cast.html#5-get-the-block-timestamp-the-log-was-emitted-in">5. Get the block timestamp the log was emitted in</a></li>
<li><a href="guides/interop/manually-relaying-interop-messages-cast.html#6-prepare-the-identifier">6. Prepare the identifier</a></li>
<li><a href="guides/interop/manually-relaying-interop-messages-cast.html#7-send-the-relaymessage-transaction">7. Send the relayMessage transaction</a></li>
<li><a href="guides/interop/manually-relaying-interop-messages-cast.html#8-check-the-balance-on-chain-902">8. Check the balance on chain 902</a></li>
</ul>
</li>
<li><a href="guides/interop/manually-relaying-interop-messages-cast.html#alternatives">Alternatives</a></li>
</ul>
<h2 id="overview-2"><a class="header" href="#overview-2">Overview</a></h2>
<h3 id="contracts-used"><a class="header" href="#contracts-used">Contracts used</a></h3>
<ul>
<li><a href="https://github.com/ethereum-optimism/supersim/blob/main/contracts/src/L2NativeSuperchainERC20.sol">L2NativeSuperchainERC20</a>
<ul>
<li><code>0x420beeF000000000000000000000000000000001</code></li>
</ul>
</li>
<li><a href="https://github.com/ethereum-optimism/optimism/blob/92ed64e171c6eb9c6a080c626640e8836f0653cc/packages/contracts-bedrock/src/L2/CrossL2Inbox.sol">CrossL2Inbox</a>
<ul>
<li><code>0x4200000000000000000000000000000000000022</code></li>
</ul>
</li>
<li><a href="https://github.com/ethereum-optimism/optimism/blob/92ed64e171c6eb9c6a080c626640e8836f0653cc/packages/contracts-bedrock/src/L2/L2ToL2CrossDomainMessenger.sol">L2ToL2CrossDomainMessenger</a>
<ul>
<li><code>0x4200000000000000000000000000000000000023</code></li>
</ul>
</li>
</ul>
<h3 id="high-level-steps"><a class="header" href="#high-level-steps">High level steps</a></h3>
<p>Sending an interop message using the <code>L2ToL2CrossDomainMessenger</code>:</p>
<p><strong>on source chain</strong> (OPChainA 901)</p>
<ol>
<li>call the <code>L2ToL2CrossChainMessenger.sendMessage</code>
<ul>
<li>the <code>L2NativeSuperchainERC20.sendERC20</code> contract will call this under the hood</li>
</ul>
</li>
<li>get the log identifier and the message payload</li>
</ol>
<p><strong>on destination chain</strong> (OPChainB 902)</p>
<ol start="3">
<li>call <code>L2ToL2CrossDomainMessenger.relayMessage</code>
<ul>
<li>this calls <code>L2NativeSuperchainERC20.relayERC20</code></li>
</ul>
</li>
</ol>
<h3 id="message-identifier"><a class="header" href="#message-identifier">Message identifier</a></h3>
<p>A message identifier uniquely identifies a log emitted on a chain.
The sequencer and smart contracts (CrossL2Inbox) use the identifier to perform <a href="https://specs.optimism.io/interop/messaging.html#messaging-invariants">invariant checks</a> to confirm that the source message is valid.</p>
<pre><code class="language-solidity">struct Identifier {
    address origin;      // Account (contract) that emits the log
    uint256 blocknumber; // Block number in which the log was emitted
    uint256 logIndex;    // Index of the log in the array of all logs emitted in the block
    uint256 timestamp;   // Timestamp that the log was emitted
    uint256 chainid;     // Chain ID of the chain that emitted the log
}
</code></pre>
<h2 id="steps"><a class="header" href="#steps">Steps</a></h2>
<h3 id="1-start-supersim"><a class="header" href="#1-start-supersim">1. Start <code>supersim</code></a></h3>
<pre><code class="language-sh">supersim
</code></pre>
<h3 id="2-mint-tokens-to-transfer-on-chain-901-1"><a class="header" href="#2-mint-tokens-to-transfer-on-chain-901-1">2. Mint tokens to transfer on chain 901</a></h3>
<p>Run the following command to mint 1000 <code>L2NativeSuperchainERC20</code> tokens to the recipient address:</p>
<pre><code class="language-sh">cast send 0x420beeF000000000000000000000000000000001 "mint(address _to, uint256 _amount)"  0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266 1000  --rpc-url http://127.0.0.1:9545 --private-key 0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80
</code></pre>
<h3 id="3-initiate-the-send-transaction-on-chain-901-1"><a class="header" href="#3-initiate-the-send-transaction-on-chain-901-1">3. Initiate the send transaction on chain 901</a></h3>
<p>Send the tokens from Chain 901 to Chain 902 using the following command:</p>
<pre><code class="language-sh">cast send 0x420beeF000000000000000000000000000000001 "sendERC20(address _to, uint256 _amount, uint256 _chainId)" 0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266 1000 902 --rpc-url http://127.0.0.1:9545 --private-key 0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80
</code></pre>
<h3 id="4-get-the-log-emitted-by-the-l2tol2crossdomainmessenger"><a class="header" href="#4-get-the-log-emitted-by-the-l2tol2crossdomainmessenger">4. Get the log emitted by the <code>L2ToL2CrossDomainMessenger</code></a></h3>
<p>The token contract calls the <a href="https://github.com/ethereum-optimism/optimism/blob/92ed64e171c6eb9c6a080c626640e8836f0653cc/packages/contracts-bedrock/src/L2/L2ToL2CrossDomainMessenger.sol">L2ToL2CrossDomainMessenger</a>, which emits a message (log) that can be executed on the destination chain.</p>
<pre><code class="language-sh">cast logs --address 0x4200000000000000000000000000000000000023 --rpc-url http://127.0.0.1:9545
</code></pre>
<p><strong>example result:</strong></p>
<pre><code class="language-sh">- address: 0x4200000000000000000000000000000000000023
  blockHash: 0x644e640094d96e379fec06f3dfbb3b03ee54cde15450543a847f61a063977e90
  blockNumber: 10
  data: 0x000000000000000000000000420beef00000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000064d9f50046000000000000000000000000f39fd6e51aad88f6f4ce6ab8827279cfffb92266000000000000000000000000f39fd6e51aad88f6f4ce6ab8827279cfffb9226600000000000000000000000000000000000000000000000000000000000003e800000000000000000000000000000000000000000000000000000000
  logIndex: 1
  removed: false
  topics: [
        0x382409ac69001e11931a28435afef442cbfd20d9891907e8fa373ba7d351f320
        0x0000000000000000000000000000000000000000000000000000000000000386
        0x000000000000000000000000420beef000000000000000000000000000000001
        0x0000000000000000000000000000000000000000000000000000000000000000
  ]
  transactionHash: 0xf6fcec6ae3941e33223cd6a63d0ffaeac1795b65c144db17e6ae7c8d3e2250dc
  transactionIndex: 0
</code></pre>
<h3 id="5-get-the-block-timestamp-the-log-was-emitted-in"><a class="header" href="#5-get-the-block-timestamp-the-log-was-emitted-in">5. Get the block timestamp the log was emitted in</a></h3>
<p>Since the message identifier requires the block timestamp, fetch the block info to get the timestamp.</p>
<pre><code class="language-sh">cast block 0xREPLACE_WITH_CORRECT_BLOCKHASH --rpc-url http://127.0.0.1:9545
</code></pre>
<p><strong>example result:</strong></p>
<pre><code class="language-sh">baseFeePerGas        301131671
difficulty           0
extraData            0x
gasLimit             30000000
gasUsed              63173
hash                 0x644e640094d96e379fec06f3dfbb3b03ee54cde15450543a847f61a063977e90
logsBloom            0x20000000000000020000000000000000000000080000000000000010000000000000000000000000000000000000000010000000000000000008000000000000000000000000000002000008000000000000000000000100000020000000000000000000020000000040000100000800000000000008000000000010000000000000000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000010000000000000000000000000040000002000000200000000000000000000000102000000800000000000020000000000000000000000000000000000000000000000000000000001400000000
miner                0x4200000000000000000000000000000000000011
mixHash              0x0000000000000000000000000000000000000000000000000000000000000000
nonce                0x0000000000000000
number               10
parentHash           0xac9dc75fdf4ab41e5b90eefb103745eade25c4b98b48dff784df7d6d45c6144a
parentBeaconRoot     
transactionsRoot     0x15e50417f6fa12895cb81dcf9db89f486d3a5760db538ebca97337d28c90f12a
receiptsRoot         0x1a3a7571e087a8200fba03d0c19d433c8293d99d7faa55d953c19006333fe75a
sha3Uncles           0x1dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d49347
size                 731
stateRoot            0xb436dee5ab769a104f36e4c1ae3d09c79ec07a8741f0b724c06f0ab8264f1cd1
timestamp            1728428155 (Tue, 8 Oct 2024 22:55:55 +0000)
withdrawalsRoot      
totalDifficulty      0
transactions:        [
        0xf6fcec6ae3941e33223cd6a63d0ffaeac1795b65c144db17e6ae7c8d3e2250dc
]
</code></pre>
<h3 id="6-construct-message-payload"><a class="header" href="#6-construct-message-payload">6. Construct message payload</a></h3>
<p>To construct the message payload we need to concatenate all the log topics and log data. These need to be concatenated as all the topics first in order and then the data:</p>
<pre><code class="language-sh"># 0x + topics[0] + topics[1] + topics[2] + topics[3] + data
0x + 382409ac69001e11931a28435afef442cbfd20d9891907e8fa373ba7d351f320 + 0000000000000000000000000000000000000000000000000000000000000386 + 000000000000000000000000420beef000000000000000000000000000000001 + 0000000000000000000000000000000000000000000000000000000000000000 + 000000000000000000000000420beef00000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000064d9f50046000000000000000000000000f39fd6e51aad88f6f4ce6ab8827279cfffb92266000000000000000000000000f39fd6e51aad88f6f4ce6ab8827279cfffb9226600000000000000000000000000000000000000000000000000000000000003e800000000000000000000000000000000000000000000000000000000
</code></pre>
<h3 id="7-prepare-the-identifier"><a class="header" href="#7-prepare-the-identifier">7. Prepare the identifier</a></h3>
<p>Now we have all the information needed for the message (log) identifier.</p>
<div class="table-wrapper"><table><thead><tr><th><strong>Parameter</strong></th><th><strong>Value</strong></th><th><strong>Note</strong></th></tr></thead><tbody>
<tr><td>origin</td><td>0x4200000000000000000000000000000000000023</td><td>L2ToL2CrossDomainMessenger</td></tr>
<tr><td>blocknumber</td><td>10</td><td>from step 4</td></tr>
<tr><td>logIndex</td><td>1</td><td>from step 4</td></tr>
<tr><td>timestamp</td><td>1728428155</td><td>from step 5</td></tr>
<tr><td>chainid</td><td>901</td><td>OPChainA chainID</td></tr>
</tbody></table>
</div>
<h3 id="8-send-the-relaymessage-transaction"><a class="header" href="#8-send-the-relaymessage-transaction">8. Send the relayMessage transaction</a></h3>
<p>Call <code>relayMessage</code> on <a href="https://github.com/ethereum-optimism/optimism/blob/a05feb362b5209ab6a200874e9d45244f12240d1/packages/contracts-bedrock/src/L2/L2ToL2CrossDomainMessenger.sol#L149">L2ToL2CrossDomainMessenger</a></p>
<pre><code class="language-solidity">// L2ToL2CrossDomainMessenger.sol (truncated for brevity)

interface ICrossL2Inbox {
  struct Identifier {
      address origin;
      uint256 blockNumber;
      uint256 logIndex;
      uint256 timestamp;
      uint256 chainId;
  }

  // ...

  function relayMessage(
      ICrossL2Inbox.Identifier calldata _id,
      bytes calldata _sentMessage
  ) payable

  // ...
}
</code></pre>
<p><strong><code>relayMessage</code> parameters</strong></p>
<ul>
<li><code>ICrossL2Inbox.Identifier calldata _id</code>: identifier pointing to the log on the source chain
<ul>
<li>same as the identifier in step 7.</li>
</ul>
</li>
<li><code>bytes calldata _sentMessage</code>: calldata to call the contract on the destination chain with.
<ul>
<li>message payload from step 6.</li>
</ul>
</li>
</ul>
<p>Below is an example call, but make sure to replace them with the correct values you received in previous steps.</p>
<pre><code class="language-sh">cast send 0x4200000000000000000000000000000000000023 \
"relayMessage((address, uint256, uint256, uint256, uint256), bytes)" \
"(0x4200000000000000000000000000000000000023, 10, 1, 1728428155, 901)" \
0x382409ac69001e11931a28435afef442cbfd20d9891907e8fa373ba7d351f3200000000000000000000000000000000000000000000000000000000000000386000000000000000000000000420beef0000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000420beef00000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000064d9f50046000000000000000000000000f39fd6e51aad88f6f4ce6ab8827279cfffb92266000000000000000000000000f39fd6e51aad88f6f4ce6ab8827279cfffb9226600000000000000000000000000000000000000000000000000000000000003e800000000000000000000000000000000000000000000000000000000 \
--rpc-url http://127.0.0.1:9546 \
--private-key 0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80
</code></pre>
<h3 id="9-check-the-balance-on-chain-902"><a class="header" href="#9-check-the-balance-on-chain-902">9. Check the balance on chain 902</a></h3>
<p>Verify that the balance of the L2NativeSuperchainERC20 on chain 902 has increased:</p>
<pre><code class="language-sh">cast balance --erc20 0x420beeF000000000000000000000000000000001 0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266 --rpc-url http://127.0.0.1:9546
</code></pre>
<h2 id="alternatives"><a class="header" href="#alternatives">Alternatives</a></h2>
<p>This is obviously very tedious to do by hand 😅. Here are some alternatives</p>
<ul>
<li>use <code>supersim --interop.autorelay</code> - this only works on supersim, but relayers for the testnet/prod environment will be available soon!</li>
<li><a href="guides/interop/relay-using-viem.html">use <code>viem</code> bindings/actions</a> - if you're using typescript, we have bindings available to make fetching identifiers and relaying messages easier</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><!-- omit in toc -->
<h1 id="using-viem-to-relay-interop-messages-typescript"><a class="header" href="#using-viem-to-relay-interop-messages-typescript">Using <code>viem</code> to relay interop messages (TypeScript)</a></h1>
<p>This guide describes how to use <a href="https://viem.sh/"><code>viem</code></a> to send and relay interop messages using the <code>L2ToL2CrossDomainMessenger</code></p>
<p>We'll perform the SuperchainERC20 interop transfer in <a href="guides/interop/../../getting-started/first-steps.html#send-an-interoperable-superchainerc20-token-from-chain-901-to-902-l2-to-l2-message-passing">First steps</a> and <a href="guides/interop/./manually-relaying-interop-messages-cast.html">Manually relaying interop messages with <code>cast</code></a> again, this time using <code>viem</code> to relay the message without the autorelayer.</p>
<ul>
<li><a href="guides/interop/relay-using-viem.html#steps">Steps</a>
<ul>
<li><a href="guides/interop/relay-using-viem.html#1-start-supersim">1. Start <code>supersim</code></a></li>
<li><a href="guides/interop/relay-using-viem.html#2-install-typescript-packages">2. Install TypeScript packages</a></li>
<li><a href="guides/interop/relay-using-viem.html#3-define-chains-and-constants">3. Define chains and constants</a></li>
<li><a href="guides/interop/relay-using-viem.html#4-mint-and-send-l2nativesuperchainerc20-on-source-chain">4. Mint and send <code>L2NativeSuperchainERC20</code> on source chain</a></li>
<li><a href="guides/interop/relay-using-viem.html#5-relay-the-message-on-the-destination-chain">5. Relay the message on the destination chain</a></li>
</ul>
</li>
<li><a href="guides/interop/relay-using-viem.html#full-code-snippet">Full code snippet</a></li>
</ul>
<h2 id="steps-1"><a class="header" href="#steps-1">Steps</a></h2>
<p>The full code snippet can be found <a href="guides/interop/relay-using-viem.html#full-code-snippet">here</a></p>
<h3 id="1-start-supersim-1"><a class="header" href="#1-start-supersim-1">1. Start <code>supersim</code></a></h3>
<pre><code class="language-sh">supersim
</code></pre>
<h3 id="2-install-typescript-packages"><a class="header" href="#2-install-typescript-packages">2. Install TypeScript packages</a></h3>
<pre><code class="language-sh">npm i viem @eth-optimism/viem
</code></pre>
<h3 id="3-define-chains-and-constants"><a class="header" href="#3-define-chains-and-constants">3. Define chains and constants</a></h3>
<pre><code class="language-ts">import {
	http,
	encodeFunctionData,
	createWalletClient,
	parseAbi,
	defineChain,
	publicActions,
} from "viem";
import { privateKeyToAccount } from "viem/accounts";
import {
	publicActionsL2,
	walletActionsL2,
	extractMessageIdentifierFromLogs,
} from "@eth-optimism/viem";
import { anvil } from "viem/chains";

// Define constants - L2NativeSuperchainERC20 contract address is the same on every chain
const L2_NATIVE_SUPERCHAINERC20_ADDRESS =
	"0x420beeF000000000000000000000000000000001";

const L2_TO_L2_CROSS_DOMAIN_MESSENGER_ADDRESS =
	"0x4200000000000000000000000000000000000023";

// account for 0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266
const account = privateKeyToAccount(
	"0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80",
);

// Define chains
const opChainA = defineChain({
	...anvil,
	id: 901,
	name: "OPChainA",
	rpcUrls: {
		default: {
			http: ["http://127.0.0.1:9545"],
		},
	},
});

const opChainB = defineChain({
	...anvil,
	id: 902,
	name: "OPChainB",
	rpcUrls: {
		default: {
			http: ["http://127.0.0.1:9546"],
		},
	},
});

// Configure op clients
const opChainAClient = createWalletClient({
	transport: http(),
	chain: opChainA,
	account,
})
	.extend(walletActionsL2())
	.extend(publicActionsL2())
	.extend(publicActions);

const opChainBClient = createWalletClient({
	transport: http(),
	chain: opChainB,
	account,
})
	.extend(walletActionsL2())
	.extend(publicActionsL2())
	.extend(publicActions);
</code></pre>
<h3 id="4-mint-and-send-l2nativesuperchainerc20-on-source-chain"><a class="header" href="#4-mint-and-send-l2nativesuperchainerc20-on-source-chain">4. Mint and send <code>L2NativeSuperchainERC20</code> on source chain</a></h3>
<pre><code class="language-ts">// #######
// OP Chain A
// #######

// 1. Mint 1000 `L2NativeSuperchainERC20` token

const mintTxHash = await opChainAClient.writeContract({
	address: L2_NATIVE_SUPERCHAINERC20_ADDRESS,
	abi: parseAbi(["function mint(address to, uint256 amount)"]),
	functionName: "mint",
	args: [account.address, 1000n],
});

await opChainAClient.waitForTransactionReceipt({ hash: mintTxHash });

// 2. Initiate sendERC20 tx
console.log("Initiating sendERC20 on OPChainA...");
const sendERC20TxHash = await opChainAClient.writeContract({
	address: L2_NATIVE_SUPERCHAINERC20_ADDRESS,
	abi: parseAbi([
		"function sendERC20(address _to, uint256 _amount, uint256 _chainId)",
	]),
	functionName: "sendERC20",
	args: [account.address, 1000n, BigInt(opChainB.id)],
});

const sendERC20TxReceipt = await opChainAClient.waitForTransactionReceipt({
	hash: sendERC20TxHash,
});

// 3. Grab the message identifier from the logs
const { id: messageIdentifier, payload: l2ToL2CrossDomainMessengerCalldata } =
	await extractMessageIdentifierFromLogs(opChainAClient, {
		receipt: sendERC20TxReceipt,
	});

</code></pre>
<h3 id="5-relay-the-message-on-the-destination-chain"><a class="header" href="#5-relay-the-message-on-the-destination-chain">5. Relay the message on the destination chain</a></h3>
<pre><code class="language-ts">
// ##########
// OP Chain B
// ##########

// 4. Execute the relayERC20 function on OPChainB
console.log("Executing L2 to L2 message on OPChainB...");
const executeTxHash = await opChainBClient.executeL2ToL2Message({
	id: messageIdentifier,
	target: L2_TO_L2_CROSS_DOMAIN_MESSENGER_ADDRESS,
	message: l2ToL2CrossDomainMessengerCalldata,
});

await opChainBClient.waitForTransactionReceipt({
	hash: executeTxHash,
});

// 5. Check balance on OPChainB
const balance = await opChainBClient.readContract({
	address: L2_NATIVE_SUPERCHAINERC20_ADDRESS,
	abi: parseAbi(["function balanceOf(address) view returns (uint256)"]),
	functionName: "balanceOf",
	args: [account.address],
});

console.log(`Balance on OPChainB: ${balance}`);
</code></pre>
<h2 id="full-code-snippet"><a class="header" href="#full-code-snippet">Full code snippet</a></h2>
<details>
  <summary>Click to view</summary>
<pre><code class="language-ts">// Using viem to transfer L2NativeSuperchainERC20

import {
	http,
	encodeFunctionData,
	createWalletClient,
	parseAbi,
	defineChain,
	publicActions,
} from "viem";
import { privateKeyToAccount } from "viem/accounts";
import {
	publicActionsL2,
	walletActionsL2,
	extractMessageIdentifierFromLogs,
} from "@eth-optimism/viem";
import { anvil } from "viem/chains";

// Define constants - L2NativeSuperchainERC20 contract address is the same on every chain
const L2_NATIVE_SUPERCHAINERC20_ADDRESS =
	"0x420beeF000000000000000000000000000000001";

const L2_TO_L2_CROSS_DOMAIN_MESSENGER_ADDRESS =
	"0x4200000000000000000000000000000000000023";

// account for 0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266
const account = privateKeyToAccount(
	"0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80",
);

// Define chains
const opChainA = defineChain({
	...anvil,
	id: 901,
	name: "OPChainA",
	rpcUrls: {
		default: {
			http: ["http://127.0.0.1:9545"],
		},
	},
});

const opChainB = defineChain({
	...anvil,
	id: 902,
	name: "OPChainB",
	rpcUrls: {
		default: {
			http: ["http://127.0.0.1:9546"],
		},
	},
});

// Configure op clients
const opChainAClient = createWalletClient({
	transport: http(),
	chain: opChainA,
	account,
})
	.extend(walletActionsL2())
	.extend(publicActionsL2())
	.extend(publicActions);

const opChainBClient = createWalletClient({
	transport: http(),
	chain: opChainB,
	account,
})
	.extend(walletActionsL2())
	.extend(publicActionsL2())
	.extend(publicActions);

// #######
// OP Chain A
// #######
// 1. Mint 1000 `L2NativeSuperchainERC20` token

const mintTxHash = await opChainAClient.writeContract({
	address: L2_NATIVE_SUPERCHAINERC20_ADDRESS,
	abi: parseAbi(["function mint(address to, uint256 amount)"]),
	functionName: "mint",
	args: [account.address, 1000n],
});

await opChainAClient.waitForTransactionReceipt({ hash: mintTxHash });

// 2. Initiate sendERC20 tx
console.log("Initiating sendERC20 on OPChainA...");
const sendERC20TxHash = await opChainAClient.writeContract({
	address: L2_NATIVE_SUPERCHAINERC20_ADDRESS,
	abi: parseAbi([
		"function sendERC20(address _to, uint256 _amount, uint256 _chainId)",
	]),
	functionName: "sendERC20",
	args: [account.address, 1000n, BigInt(opChainB.id)],
});

const sendERC20TxReceipt = await opChainAClient.waitForTransactionReceipt({
	hash: sendERC20TxHash,
});

// 3. Grab the message identifier from the logs
const { id: messageIdentifier, payload: l2ToL2CrossDomainMessengerCalldata } =
	await extractMessageIdentifierFromLogs(opChainAClient, {
		receipt: sendERC20TxReceipt,
	});

// ##########
// OP Chain B
// ##########
// 4. Execute the relayERC20 function on OPChainB
console.log("Executing L2 to L2 message on OPChainB...");
const executeTxHash = await opChainBClient.executeL2ToL2Message({
	id: messageIdentifier,
	target: L2_TO_L2_CROSS_DOMAIN_MESSENGER_ADDRESS,
	message: l2ToL2CrossDomainMessengerCalldata,
});

await opChainBClient.waitForTransactionReceipt({
	hash: executeTxHash,
});

// 5. Check balance on OPChainB
const balance = await opChainBClient.readContract({
	address: L2_NATIVE_SUPERCHAINERC20_ADDRESS,
	abi: parseAbi(["function balanceOf(address) view returns (uint256)"]),
	functionName: "balanceOf",
	args: [account.address],
});

console.log(`Balance on OPChainB: ${balance}`);

</code></pre>
<div style="break-before: page; page-break-before: always;"></div><!-- omit in toc -->
<h1 id="writing-cross-chain-contract-using-l2tol2crossdomainmessenger"><a class="header" href="#writing-cross-chain-contract-using-l2tol2crossdomainmessenger">Writing cross-chain contract using <code>L2ToL2CrossDomainMessenger</code></a></h1>
<p>This guide walks through the <code>CrossChainPingPong.sol</code> contract, focusing on high level design and steps on integrating the <code>L2ToL2CrossChainMessenger</code> contract. The source code can be found <a href="https://github.com/ethereum-optimism/supersim/blob/f400984d8057fe54cfbaabee279a6a45cd41411b/contracts/src/CrossChainPingPong.sol">here</a>.</p>
<ul>
<li><a href="guides/interop/writing-contract-using-l2cdm.html#high-level-overview">High level overview</a>
<ul>
<li><a href="guides/interop/writing-contract-using-l2cdm.html#diagram">Diagram</a></li>
<li><a href="guides/interop/writing-contract-using-l2cdm.html#flow">Flow</a>
<ul>
<li><a href="guides/interop/writing-contract-using-l2cdm.html#1-contract-deployment">1. Contract Deployment</a></li>
<li><a href="guides/interop/writing-contract-using-l2cdm.html#2-initiate-game-serve">2. Initiate Game (Serve)</a></li>
<li><a href="guides/interop/writing-contract-using-l2cdm.html#3-send-cross-chain-message">3. Send Cross-Chain Message</a></li>
<li><a href="guides/interop/writing-contract-using-l2cdm.html#4-receive-on-destination-chain">4. Receive on Destination Chain</a></li>
<li><a href="guides/interop/writing-contract-using-l2cdm.html#5-continue-game-hit">5. Continue Game (Hit)</a></li>
<li><a href="guides/interop/writing-contract-using-l2cdm.html#key-points">Key Points</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="guides/interop/writing-contract-using-l2cdm.html#walkthrough">Walkthrough</a>
<ul>
<li><a href="guides/interop/writing-contract-using-l2cdm.html#initializing-contract-states">Initializing contract states</a>
<ul>
<li><a href="guides/interop/writing-contract-using-l2cdm.html#constructor-setup">Constructor Setup</a></li>
<li><a href="guides/interop/writing-contract-using-l2cdm.html#synchronizing-the-game-start">Synchronizing the Game Start</a></li>
<li><a href="guides/interop/writing-contract-using-l2cdm.html#reliance-on-create2-for-cross-chain-consistency">Reliance on CREATE2 for Cross-Chain Consistency</a></li>
</ul>
</li>
<li><a href="guides/interop/writing-contract-using-l2cdm.html#sending-a-cross-chain-message">Sending a cross chain message</a>
<ul>
<li><a href="guides/interop/writing-contract-using-l2cdm.html#1-encode-the-function-call">1. Encode the function call</a></li>
<li><a href="guides/interop/writing-contract-using-l2cdm.html#2-send-the-cross-domain-message">2. Send the cross-domain message</a></li>
<li><a href="guides/interop/writing-contract-using-l2cdm.html#why-were-sending-a-receiveball-function-call">Why we're sending a <code>receiveBall</code> function call</a></li>
</ul>
</li>
<li><a href="guides/interop/writing-contract-using-l2cdm.html#receiving-a-cross-chain-message">Receiving a cross chain message</a>
<ul>
<li><a href="guides/interop/writing-contract-using-l2cdm.html#1-check-msgsender-to-verify-the-caller">1. Check <code>msg.sender</code> to verify the caller</a></li>
<li><a href="guides/interop/writing-contract-using-l2cdm.html#2-check-the-sender-of-the-message-on-the-source-chain">2. Check the sender of the message on the source chain</a></li>
<li><a href="guides/interop/writing-contract-using-l2cdm.html#3-make-state-updates-and-emit-events">3. Make state updates and emit events</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="guides/interop/writing-contract-using-l2cdm.html#takeaways">Takeaways</a></li>
</ul>
<h2 id="high-level-overview"><a class="header" href="#high-level-overview">High level overview</a></h2>
<p><code>CrossChainPingPong.sol</code> implements a cross-chain ping-pong game using the L2ToL2CrossDomainMessenger.</p>
<ul>
<li>Players hit a virtual ** <em>ball</em> ** back and forth between allowed L2 chains. The game starts with a serve</li>
<li>from a designated start chain, and each hit increases the rally count. The contract tracks the last hitter's address, chain ID, and the current rally count.</li>
</ul>
<h3 id="diagram"><a class="header" href="#diagram">Diagram</a></h3>
<pre class="mermaid">sequenceDiagram
    participant Chain1 as Chain 1 (First serve)
    participant Chain2 as Chain 2
    
    Note over Chain1: 🚀 Game Starts
    Note over Chain1: 🏓 Serve Ball
    Chain1-&gt;&gt;Chain2: 📤 Send PingPongBall {rallyCount: 1, lastHitter: Chain1}
    Chain1--&gt;&gt;Chain1: Emit BallSent event
    activate Chain2
    Note over Chain2: 📥 Receive Ball
        Chain2--&gt;&gt;Chain2: Emit BallReceived event

    Note over Chain2: 🏓 Hit Ball
    Chain2-&gt;&gt;Chain1: 📤 Send PingPongBall {rallyCount: 2, lastHitter: Chain2}
    Chain2--&gt;&gt;Chain2: Emit BallSent event
    deactivate Chain2
    activate Chain1
    Note over Chain1: 📥 Receive Ball
        Chain1--&gt;&gt;Chain1: Emit BallReceived event
    Note over Chain1: 🏓 Hit Ball
    Chain1-&gt;&gt;Chain2: 📤 Send PingPongBall {rallyCount: 3, lastHitter: Chain1}
    Chain1--&gt;&gt;Chain1: Emit BallSent event
    deactivate Chain1
    Note over Chain1,Chain2: Game continues...
</pre>
<h3 id="flow"><a class="header" href="#flow">Flow</a></h3>
<h4 id="1-contract-deployment"><a class="header" href="#1-contract-deployment">1. Contract Deployment</a></h4>
<ul>
<li>Deploy identical <code>CrossChainPingPong.sol</code> contracts on multiple L2 chains.</li>
<li>Contracts are deployed using CREATE2 with the same parameter (<code>_allowedChainIds</code> and starting <code>_serverChainId</code>), resulting in the same address and initial state.</li>
</ul>
<h4 id="2-initiate-game-serve"><a class="header" href="#2-initiate-game-serve">2. Initiate Game (Serve)</a></h4>
<ul>
<li>Call <code>serveBallTo</code> on the designated server chain, specifying a destination chain.</li>
<li>This can only be done once to start the game.</li>
<li>Contract creates initial <code>PingPongBall</code> struct.</li>
</ul>
<h4 id="3-send-cross-chain-message"><a class="header" href="#3-send-cross-chain-message">3. Send Cross-Chain Message</a></h4>
<ul>
<li>Contract uses <code>L2ToL2CrossDomainMessenger</code> to send the ball data to the specified chain.</li>
</ul>
<h4 id="4-receive-on-destination-chain"><a class="header" href="#4-receive-on-destination-chain">4. Receive on Destination Chain</a></h4>
<ul>
<li>L2ToL2CrossDomainMessenger on destination chain calls <code>receiveBall</code>.</li>
<li>Contract verifies the message sender and origin.</li>
<li>Ball data is stored, and the ball is marked as present on this chain.</li>
</ul>
<h4 id="5-continue-game-hit"><a class="header" href="#5-continue-game-hit">5. Continue Game (Hit)</a></h4>
<ul>
<li>Any user on the chain currently holding the ball calls <code>hitBallTo</code> to send it to another chain.</li>
<li>Contract updates the <code>PingPongBall</code> data (increment rally count, update last hitter).</li>
<li>Process repeats from step 3.</li>
</ul>
<h4 id="key-points"><a class="header" href="#key-points">Key Points</a></h4>
<ul>
<li>Game starts with <code>serveBallTo</code> on a designated chain (server).</li>
<li>After serving, <code>hitBallTo</code> is used to continue the game.</li>
<li>Each contract instance can both send and receive balls.</li>
<li>The contract tracks whether it currently holds the ball.</li>
<li>Cross-chain messaging is handled by L2ToL2CrossDomainMessenger.</li>
</ul>
<h2 id="walkthrough"><a class="header" href="#walkthrough">Walkthrough</a></h2>
<p>Here's an explanation of the functions in the contract, with a focus on how it interacts with <code>L2ToL2CrossChainMessenger</code>.</p>
<h3 id="initializing-contract-states"><a class="header" href="#initializing-contract-states">Initializing contract states</a></h3>
<h4 id="constructor-setup"><a class="header" href="#constructor-setup">Constructor Setup</a></h4>
<pre><code class="language-solidity">constructor(uint256[] memory _allowedChainIds, uint256 _serverChainId) {
    for (uint256 i = 0; i &lt; _allowedChainIds.length; i++) {
        _isChainIdAllowed[_allowedChainIds[i]] = true;
    }

    if (!_isChainIdAllowed[_serverChainId]) {
        revert InvalidDestinationChain(_serverChainId);
    }

    SERVER_CHAIN_ID = _serverChainId;
}
</code></pre>
<p>This constructor initializes the contract with two crucial pieces of information:</p>
<ol>
<li><strong>Allowed Chain IDs</strong>: It populates the <code>_isChainIdAllowed</code> mapping, which determines which chains can participate in the game.</li>
<li><strong>Server Chain ID</strong>: It sets the <code>SERVER_CHAIN_ID</code>, designating which chain has the authority to start the game.</li>
</ol>
<h4 id="synchronizing-the-game-start"><a class="header" href="#synchronizing-the-game-start">Synchronizing the Game Start</a></h4>
<p>The contract uses a simple mechanism to ensure the game starts correctly across all chains:</p>
<ol>
<li>
<p><strong>Designate the server chain</strong>:</p>
<pre><code class="language-solidity">if (SERVER_CHAIN_ID != block.chainid) {
    revert UnauthorizedServer(block.chainid, SERVER_CHAIN_ID);
}
</code></pre>
<p>Only the designated server chain can initiate the game.</p>
</li>
<li>
<p><strong>Only be able to serve once</strong></p>
<pre><code class="language-solidity">if (_hasServerAlreadyServed) {
    revert BallAlreadyServed();
}
_hasServerAlreadyServed = true;
</code></pre>
<p>This ensures the ball is served only once, preventing multiple game initiations.</p>
</li>
</ol>
<p>By using these checks in the <code>serveBallTo</code> function, the contract ensures that:</p>
<ul>
<li>The game starts from a single, predetermined chain.</li>
<li>The initial serve happens only once.</li>
<li>All other chains wait to receive the ball before they can participate.</li>
</ul>
<p>Because this contract is simple, it doesn't require complex time-based coordination or post-deployment setup. The game naturally begins when the server chain calls <code>serveBallTo</code>, and other chains join the game as they receive the ball.</p>
<h4 id="reliance-on-create2-for-cross-chain-consistency"><a class="header" href="#reliance-on-create2-for-cross-chain-consistency">Reliance on CREATE2 for Cross-Chain Consistency</a></h4>
<p>While not explicitly mentioned in the code, this contract's design implicitly assumes the use of CREATE2 for deployment. Here's why CREATE2 is crucial for this setup:</p>
<ol>
<li>
<p><strong>Predictable Addresses</strong>:
CREATE2 enables deployment at the same address on all chains, crucial for cross-chain message verification:</p>
<pre><code class="language-solidity">if (IL2ToL2CrossDomainMessenger(MESSENGER).crossDomainMessageSender() != address(this)) {
    revert InvalidCrossDomainSender();
}
</code></pre>
</li>
<li>
<p><strong>Self-referential Messaging</strong>:
The contract sends messages to itself on other chains:</p>
<pre><code class="language-solidity">IL2ToL2CrossDomainMessenger(MESSENGER).sendMessage(_toChainId, address(this), _message);
</code></pre>
<p>This requires <code>address(this)</code> to be consistent across chains.</p>
</li>
<li>
<p><strong>Initialization State Considerations</strong>:
The constructor parameters (<code>_allowedChainIds</code> and <code>_serverChainId</code>) affect the contract's initialization state. Different values will result in different contract addresses when using CREATE2. To maintain address consistency:</p>
<ul>
<li>Use identical <code>_allowedChainIds</code> arrays (same values in the same order)</li>
<li>Use the same <code>_serverChainId</code>
across all chain deployments.</li>
</ul>
</li>
</ol>
<p>Without CREATE2, you would need to:</p>
<ul>
<li>Manually track contract addresses for each chain.</li>
<li>Implement a more complex initialization process to register contract addresses across chains.</li>
<li>Potentially redesign the security model that relies on address matching.</li>
</ul>
<h3 id="sending-a-cross-chain-message"><a class="header" href="#sending-a-cross-chain-message">Sending a cross chain message</a></h3>
<p>Two functions initiate a message send</p>
<ul>
<li>
<p><code>serveBallTo</code>: This function initiates the game by serving the ball from the designated server chain to another chain.</p>
</li>
<li>
<p><code>hitBallTo</code>: This function is used to hit the ball to another chain after receiving it.</p>
</li>
</ul>
<p>Both functions create a new <code>PingPongBall</code> struct with updated information and then call <code>_sendCrossDomainMessage</code> to transmit this ball data to the specified destination chain.</p>
<p>Now, let's look at how <code>_sendCrossDomainMessage</code> works:</p>
<pre><code class="language-solidity">function _sendCrossDomainMessage(PingPongBall memory _ball, uint256 _toChainId) internal {
    bytes memory _message = abi.encodeCall(this.receiveBall, (_ball));
    IL2ToL2CrossDomainMessenger(MESSENGER).sendMessage(_toChainId, address(this), _message);
}
</code></pre>
<h4 id="1-encode-the-function-call"><a class="header" href="#1-encode-the-function-call">1. Encode the function call</a></h4>
<pre><code class="language-solidity">bytes memory _message = abi.encodeCall(this.receiveBall, (_ball));
</code></pre>
<ul>
<li>The encoded message includes the function selector for <code>receiveBall</code> and the ABI-encoded <code>_ball</code> struct.</li>
<li>By encoding a call to <code>receiveBall</code>, we're instructing the destination chain's messenger to execute this function when it receives the message.</li>
</ul>
<h4 id="2-send-the-cross-domain-message"><a class="header" href="#2-send-the-cross-domain-message">2. Send the cross-domain message</a></h4>
<pre><code class="language-solidity">IL2ToL2CrossDomainMessenger(MESSENGER).sendMessage(_toChainId, address(this), _message);
</code></pre>
<ul>
<li>Calls the <code>sendMessage</code> function on the <code>L2ToL2CrossDomainMessenger</code> to initiate cross-chain communication.</li>
<li>Parameters:
<ul>
<li><code>_toChainId</code>: Specifies the destination chain.</li>
<li><code>address(this)</code>: Ensures the message appears to come from the corresponding <code>CrossChainPingPong</code> contract on the receiving chain.</li>
<li><code>_message</code>: The encoded function call created in step 1.</li>
</ul>
</li>
<li>Relies on the <code>L2ToL2CrossDomainMessenger</code> to securely bridge the message to the specified chain.</li>
</ul>
<h4 id="why-were-sending-a-receiveball-function-call"><a class="header" href="#why-were-sending-a-receiveball-function-call">Why we're sending a <code>receiveBall</code> function call</a></h4>
<ul>
<li>We're not directly calling <code>receiveBall</code> on another chain. Instead, we're sending a message to the <code>L2ToL2CrossDomainMessenger</code> on the destination chain.</li>
<li>This message instructs the messenger to execute the <code>receiveBall</code> function on our behalf.</li>
<li>The process works like this:
<ol>
<li>Our contract encodes a call to <code>receiveBall</code> with the ball data.</li>
<li>We send this encoded call to the <code>L2ToL2CrossDomainMessenger</code> on the current chain.</li>
<li>The messenger system relays this to the corresponding messenger on the destination chain.</li>
<li>The destination chain's messenger receives the message and executes the encoded <code>receiveBall</code> call on our contract.</li>
</ol>
</li>
</ul>
<h3 id="receiving-a-cross-chain-message"><a class="header" href="#receiving-a-cross-chain-message">Receiving a cross chain message</a></h3>
<pre><code class="language-solidity">function receiveBall(PingPongBall memory _ball) external {
    if (msg.sender != MESSENGER) {
        revert CallerNotL2ToL2CrossDomainMessenger();
    }

    if (IL2ToL2CrossDomainMessenger(MESSENGER).crossDomainMessageSender() != address(this)) {
        revert InvalidCrossDomainSender();
    }

    _receivedBall = _ball;
    _isBallPresent = true;

    emit BallReceived(IL2ToL2CrossDomainMessenger(MESSENGER).crossDomainMessageSource(), block.chainid, _ball);
}
</code></pre>
<h4 id="1-check-msgsender-to-verify-the-caller"><a class="header" href="#1-check-msgsender-to-verify-the-caller">1. Check <code>msg.sender</code> to verify the caller</a></h4>
<pre><code class="language-solidity">  if (msg.sender != MESSENGER) {
      revert CallerNotL2ToL2CrossDomainMessenger();
  }
</code></pre>
<ul>
<li>The <code>receiveBall</code> function must only be called by the trusted <code>L2ToL2CrossDomainMessenger</code>. This messenger is responsible for handling cross-chain messages securely, so we need to verify that it is indeed the caller.</li>
<li>Without this check, any external user could directly call <code>receiveBall</code> and pass arbitrary <code>_ball</code> data, bypassing the intended cross-chain communication flow.</li>
<li>We rely on <code>L2ToL2CrossDomainMessenger</code> to ensure that:
<ul>
<li>The function is only triggered by a valid message sent from another chain.</li>
<li>The source chain's sender address and chain ID are correctly relayed.</li>
<li>Messages can’t be replayed or sent twice, preserving game integrity.</li>
</ul>
</li>
</ul>
<h4 id="2-check-the-sender-of-the-message-on-the-source-chain"><a class="header" href="#2-check-the-sender-of-the-message-on-the-source-chain">2. Check the sender of the message on the source chain</a></h4>
<pre><code class="language-solidity">  if (IL2ToL2CrossDomainMessenger(MESSENGER).crossDomainMessageSender() != address(this)) {
      revert InvalidCrossDomainSender();
  }
</code></pre>
<ul>
<li>The second check ensures that the message originated from the correct <code>CrossChainPingPong</code> contract on the source chain (the chain where someone called <code>hitBallTo</code>).
<ul>
<li>Leverages the fact that CrossChainPingPong contracts are deployed identically across chains, using deterministic deployment methods like CREATE2.</li>
</ul>
</li>
<li>Without verifying this, any contract on a different chain could send an arbitrary <code>_ball</code> through the messenger, potentially disrupting the game's state.</li>
<li>Since the <code>CrossChainPingPong</code> contract is deployed with identical logic across chains, we trust that only the intended contract would trigger this message in the correct game context.</li>
</ul>
<h4 id="3-make-state-updates-and-emit-events"><a class="header" href="#3-make-state-updates-and-emit-events">3. Make state updates and emit events</a></h4>
<pre><code class="language-solidity">  _receivedBall = _ball;
  _isBallPresent = true;

  emit BallReceived(IL2ToL2CrossDomainMessenger(MESSENGER).crossDomainMessageSource(), block.chainid, _ball);
</code></pre>
<p>Updates the contract on this chain to keep the state of the ball and mark that it's present on this chain.</p>
<h2 id="takeaways"><a class="header" href="#takeaways">Takeaways</a></h2>
<p>This is just one of many patterns to use the L2ToL2CrossDomainMessenger in your contract to power cross-chain calls. Key points to remember:</p>
<ol>
<li>
<p><strong>Simple Message Passing</strong>: This design sends simple messages between identical contracts on different chains. Each message contains only the essential game state (rally count, last hitter). More complex systems might involve multiple contracts, intermediary relayers.</p>
</li>
<li>
<p><strong>Cross-Chain Sender Verification</strong>: Always verify the sender of cross-chain messages. This includes checking both the immediate caller (the messenger) and the original sender on the source chain.</p>
</li>
<li>
<p><strong>Cross-Chain Contract Coordination</strong>: This design uses CREATE2 for consistent contract addresses across chains, simplifying cross-chain verification. Alternative approaches include:</p>
<ul>
<li>Beacon proxy patterns for upgradeable contracts</li>
<li>Post-deployment setup where contract addresses are specified after deployment</li>
</ul>
</li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><h1 id="cross-chain-tic-tac-toe"><a class="header" href="#cross-chain-tic-tac-toe">Cross-chain tic-tac-toe</a></h1>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->
        <script src="src/static/mermaid.min.js"></script>
        <script src="src/static/mermaid-init.js"></script>
        <script src="src/static/solidity.min.js"></script>

        <script>
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>

    </div>
    </body>
</html>
